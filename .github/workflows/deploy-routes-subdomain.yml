name: Deploy Routes Subdomain

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build Next.js site
      run: npm run build
      
    - name: Prepare routes subdomain
      run: |
        # Create a temp directory for routes subdomain
        mkdir -p routes-deploy
        
        # Copy the entire built site first
        cp -r out/* routes-deploy/
        
        # Create CNAME for routes subdomain
        echo "routes.pedal-peak.com" > routes-deploy/CNAME
        
        # Create a simple redirect from the root to /routes
        cat > routes-deploy/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Redirecting to Routes...</title>
          <meta http-equiv="refresh" content="0; url=/routes/">
          <link rel="canonical" href="/routes/">
        </head>
        <body>
          <script>window.location.replace("/routes/");</script>
          <p>If you are not redirected automatically, <a href="/routes/">click here</a>.</p>
        </body>
        </html>
        EOF
        
    - name: Deploy to gh-pages-routes branch
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages-routes
        folder: routes-deploy
        clean: true